{% extends 'academics/base.html' %}


{% block body %}
<style>
  body, html {
    height: 100%;
    margin: 0;
    background-color: #0e0e0e;
    color: white;
    font-family: 'Segoe UI', sans-serif;
  }

  .chat-wrapper {
    display: flex;
    flex-direction: column;
    height: 100vh;
  }

  .chat-box {
    flex: 1;
    overflow-y: auto;
    padding: 1rem;
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .chat-message {
    padding: 1rem;
    border-radius: 10px;
    max-width: 80%;
    word-wrap: break-word;
    white-space: pre-wrap;
  }

  .user-message {
    align-self: flex-end;
    background-color: #2a2a2a;
  }

  .ai-message {
    align-self: flex-start;
    background-color: #1f1f1f;
  }

  .input-bar {
    display: flex;
    padding: 1rem;
    background-color: #0e0e0e;
    border-top: 1px solid #333;
  }

  .input-bar textarea {
    flex: 1;
    padding: 0.75rem 1rem;
    border-radius: 10px;
    border: none;
    resize: none;
    font-size: 1rem;
    background-color: #1a1a1a;
    color: white;
    outline: none;
  }

  .input-bar button {
    margin-left: 1rem;
    padding: 0.75rem 1.25rem;
    background-color: #007bff;
    color: white;
    border: none;
    border-radius: 8px;
    font-weight: bold;
    cursor: pointer;
  }

  .placeholder {
    text-align: center;
    margin-top: auto;
    margin-bottom: auto;
  }
</style>

<div class="chat-wrapper">
  <div class="chat-box" id="chat-box">
    <div class="placeholder" id="welcome-text">
      <h1 style="font-size: 2.2rem; color: #00bcd4; font-weight: bold;">
        üëã Welcome to <span style="color:#1e90ff;">AI-Tutor</span>
      </h1>
      <p style="color: #aaa; font-size: 1.1rem; margin-top: 0.5rem;">
        Ask your programming questions below and get instant help!
      </p>
    </div>
  </div>

  <form method="post" class="input-bar" id="chat-form">
    {% csrf_token %}
    <textarea name="prompt" id="prompt-input" rows="1" placeholder="Ask Something..." required></textarea>
    <button type="submit">‚û§</button>
  </form>
</div>

<!-- ‚úÖ jQuery (Required) -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism.css" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/prism.js"></script>
<script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-java.min.js"></script>
<script>
  const chatBox = $('#chat-box');

  function appendMessage(text, type) {
    const message = $('<div></div>')
      .addClass('chat-message')
      .addClass(type === 'user' ? 'user-message' : 'ai-message')
      //.text(text);
      chatBox.append(message);
      chatBox.scrollTop(chatBox[0].scrollHeight);
      if (type=='ai'){
        let i =0;
        const interval = setInterval(function(){
          message.text(message.text()+text.charAt(i));
          i++;
          if(text.charAt(i)==="`" && text.charAt(i+1)==="`"){
            $('<pre><code></code></pre>').addClass('chat-message')
          }
          chatBox.scrollTop(chatBox[0].scrollHeight);
          if(i >= text.length) clearInterval(interval);
        }, 20);
      }else{
        message.text(text);
      }
    
    
  }

  $('#chat-form').on('submit', function (e) {
    e.preventDefault();
    const prompt = $('#prompt-input').val().trim();
    if (!prompt) return;

    $('#welcome-text').remove();  // remove welcome on first question
    appendMessage(prompt, 'user');
    $('#prompt-input').val(''); // clear input

    $.ajax({
      type: 'POST',
      url: '{% url "ask_gemini" %}',  // Your Django URL pattern
      data: {
        prompt: prompt,
        csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val()
      },
      success: function (data) {
        appendMessage(data.response, 'ai');
      },
      error: function () {
        appendMessage("‚ö†Ô∏è Something went wrong. Please try again.", 'ai');
      }
    });
  });
</script>
{% endblock %}
